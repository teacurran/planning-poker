apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: scrum-poker-backend
  labels:
    app: scrum-poker-backend
    app.kubernetes.io/name: scrum-poker-backend
    app.kubernetes.io/component: backend
    app.kubernetes.io/part-of: scrum-poker-platform
  annotations:
    # ==========================================
    # AWS ALB Ingress Controller Annotations
    # ==========================================
    # Use these annotations if deploying on AWS EKS with ALB Ingress Controller
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'

    # TLS certificate from AWS Certificate Manager (ACM)
    # Replace with actual certificate ARN in environment overlays
    alb.ingress.kubernetes.io/certificate-arn: <ACM_CERTIFICATE_ARN_PLACEHOLDER>

    # Sticky sessions for WebSocket connections (24 hours = 86400 seconds)
    # Ensures WebSocket connections stay on same pod for optimal Redis Pub/Sub
    alb.ingress.kubernetes.io/target-group-attributes: stickiness.enabled=true,stickiness.type=lb_cookie,stickiness.lb_cookie.duration_seconds=86400

    # Health check configuration
    alb.ingress.kubernetes.io/healthcheck-path: /q/health/ready
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-port: traffic-port
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '15'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'

    # Connection settings for WebSocket support
    alb.ingress.kubernetes.io/backend-protocol: HTTP
    alb.ingress.kubernetes.io/target-group-attributes.deregistration_delay.timeout_seconds: '30'

    # ==========================================
    # Nginx Ingress Controller Annotations
    # ==========================================
    # Use these annotations if deploying with Nginx Ingress Controller
    nginx.ingress.kubernetes.io/affinity: cookie
    nginx.ingress.kubernetes.io/session-cookie-name: INGRESSCOOKIE
    nginx.ingress.kubernetes.io/session-cookie-expires: "86400"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "86400"
    nginx.ingress.kubernetes.io/session-cookie-path: /
    nginx.ingress.kubernetes.io/session-cookie-samesite: Strict

    # WebSocket support
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-body-size: "8m"

    # SSL redirect
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

spec:
  # Ingress class - uncomment and set based on your ingress controller
  # ingressClassName: alb  # For AWS ALB Ingress Controller
  # ingressClassName: nginx  # For Nginx Ingress Controller

  # TLS configuration
  tls:
  - hosts:
    - <DOMAIN_PLACEHOLDER>  # Replace in overlays (e.g., scrumpoker.com)
    secretName: scrum-poker-tls  # For Nginx with cert-manager, or omit for ALB (uses ACM)

  rules:
  - host: <DOMAIN_PLACEHOLDER>  # Replace in overlays
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: scrum-poker-backend
            port:
              number: 80

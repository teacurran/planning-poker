[
  {
    "task_id": "I2.T1",
    "iteration_id": "I2",
    "iteration_goal": "Implement foundational domain services (Room Service, basic User Service), define REST API contracts (OpenAPI specification), and establish WebSocket protocol specification to enable frontend integration and parallel feature development.",
    "description": "Create comprehensive OpenAPI 3.1 YAML specification documenting all planned REST API endpoints. Define schemas for DTOs (UserDTO, RoomDTO, SubscriptionDTO, etc.), request bodies, response structures, error codes (400, 401, 403, 404, 500 with standardized error schema). Document endpoints for: user management (`/api/v1/users/*`), room CRUD (`/api/v1/rooms/*`), authentication (`/api/v1/auth/*`), subscriptions (`/api/v1/subscriptions/*`), reporting (`/api/v1/reports/*`), organizations (`/api/v1/organizations/*`). Include security schemes (Bearer JWT, OAuth2 flows). Add descriptions, examples, and validation rules (min/max lengths, patterns, required fields).",
    "agent_type_hint": "DocumentationAgent",
    "inputs": "REST API endpoint overview from architecture blueprint (Section 4 - API Design), Entity models from I1.T4 (for DTO schema definitions), Authentication/authorization requirements",
    "input_files": [
      ".codemachine/artifacts/architecture/04_Behavior_and_Communication.md",
      "backend/src/main/java/com/scrumpoker/domain/**/*.java"
    ],
    "target_files": [
      "api/openapi.yaml",
      "docs/api-design.md"
    ],
    "deliverables": "OpenAPI 3.1 YAML file with 30+ endpoint definitions, Complete schema definitions for all DTOs (User, Room, Vote, Subscription, Organization, etc.), Error response schema with standardized structure (`{\"error\": \"...\", \"message\": \"...\", \"timestamp\": \"...\"}`), Security scheme definitions (JWT Bearer, OAuth2 authorization code flow), Request/response examples for critical endpoints, Validation rules in schemas (string formats, numeric ranges, enum values)",
    "acceptance_criteria": "OpenAPI file validates against OpenAPI 3.1 schema (use Swagger Editor or spectral), All CRUD endpoints for core entities documented, Security requirements specified for protected endpoints, DTO schemas match database entity structure (field names, types, nullability), Error responses follow consistent structure across all endpoints, File imports successfully into Swagger UI or Redoc for documentation rendering",
    "dependencies": [],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I2.T2",
    "iteration_id": "I2",
    "iteration_goal": "Implement foundational domain services (Room Service, basic User Service), define REST API contracts (OpenAPI specification), and establish WebSocket protocol specification to enable frontend integration and parallel feature development.",
    "description": "Create comprehensive Markdown document specifying WebSocket communication protocol. Define message envelope structure (`{\"type\": \"message_type.v1\", \"requestId\": \"uuid\", \"payload\": {...}}`). Document all message types: client-to-server (`room.join.v1`, `vote.cast.v1`, `chat.message.v1`, `round.reveal.v1`), server-to-client (`vote.recorded.v1`, `round.revealed.v1`, `room.participant_joined.v1`, `error.v1`). Provide JSON schema for each payload type. Define error codes (4000-4999 for application errors). Specify connection lifecycle (handshake with JWT token, heartbeat protocol, graceful/ungraceful disconnection). Document versioning strategy for message types.",
    "agent_type_hint": "DocumentationAgent",
    "inputs": "WebSocket communication patterns from architecture blueprint (Section 4), Vote casting sequence diagram, WebSocket message types overview",
    "input_files": [
      ".codemachine/artifacts/architecture/04_Behavior_and_Communication.md"
    ],
    "target_files": [
      "api/websocket-protocol.md",
      "api/websocket-message-schemas.json"
    ],
    "deliverables": "Markdown specification document (10+ pages), Message envelope definition with required/optional fields, 20+ message type definitions with JSON schema payloads, Error code catalog (4000: Unauthorized, 4001: Room not found, 4002: Invalid vote, etc.), Connection lifecycle diagram (PlantUML or Mermaid), Versioning policy explanation (backward compatibility guarantees)",
    "acceptance_criteria": "All message types from architecture blueprint documented, JSON schemas validate sample messages (test with AJV or similar validator), Error codes cover common failure scenarios (auth, validation, server error), Connection lifecycle clearly explains handshake, heartbeat, reconnection, Versioning strategy enables protocol evolution without breaking clients, Document reviewed by backend and frontend leads for completeness",
    "dependencies": [],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I2.T3",
    "iteration_id": "I2",
    "iteration_goal": "Implement foundational domain services (Room Service, basic User Service), define REST API contracts (OpenAPI specification), and establish WebSocket protocol specification to enable frontend integration and parallel feature development.",
    "description": "Create `RoomService` domain service implementing core room operations: create room (generate 6-character nanoid, validate privacy mode, initialize config JSONB), update room configuration (deck type, rules, title), delete room (soft delete with `deleted_at`), find room by ID, list rooms by owner. Use `RoomRepository` for database operations. Implement reactive methods returning `Uni<>` for single results, `Multi<>` for lists. Validate business rules (room title length, valid privacy modes, deck type enum). Handle JSONB serialization for room configuration. Add transaction boundaries with `@Transactional`.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Room entity and repository from I1, Room management requirements from product spec, Nanoid generation pattern (6 characters, a-z0-9)",
    "input_files": [
      "backend/src/main/java/com/scrumpoker/domain/room/Room.java",
      "backend/src/main/java/com/scrumpoker/repository/RoomRepository.java"
    ],
    "target_files": [
      "backend/src/main/java/com/scrumpoker/domain/room/RoomService.java",
      "backend/src/main/java/com/scrumpoker/domain/room/RoomConfig.java",
      "backend/src/main/java/com/scrumpoker/domain/room/RoomNotFoundException.java"
    ],
    "deliverables": "RoomService class with methods: `createRoom()`, `updateRoomConfig()`, `deleteRoom()`, `findById()`, `findByOwnerId()`, Nanoid generation utility for unique room IDs, RoomConfig POJO with fields: deckType, timerEnabled, timerDurationSeconds, revealBehavior, Business validation (title max 200 chars, valid privacy enum), Reactive return types (Uni, Multi), Custom exception for room not found scenarios",
    "acceptance_criteria": "Service methods compile and pass unit tests (mocked repository), Room creation generates unique 6-character IDs (test collision resistance with 1000 iterations), JSONB config serialization/deserialization works correctly, Soft delete sets `deleted_at` timestamp without removing database row, Business validation throws appropriate exceptions (e.g., `IllegalArgumentException` for invalid title), Service transactional boundaries configured correctly",
    "dependencies": ["I1.T4", "I1.T7"],
    "parallelizable": false,
    "done": false
  },
  {
    "task_id": "I2.T4",
    "iteration_id": "I2",
    "iteration_goal": "Implement foundational domain services (Room Service, basic User Service), define REST API contracts (OpenAPI specification), and establish WebSocket protocol specification to enable frontend integration and parallel feature development.",
    "description": "Create `UserService` domain service for user profile operations: create user (from OAuth profile), update profile (display name, avatar URL), get user by ID, find by email, update user preferences (default deck type, theme, notification settings). Use `UserRepository` and `UserPreferenceRepository`. Implement reactive methods. Handle JSONB serialization for UserPreference.notification_settings and default_room_config. Validate email format, display name length constraints. Implement soft delete for user accounts (GDPR compliance).",
    "agent_type_hint": "BackendAgent",
    "inputs": "User and UserPreference entities from I1, User repositories from I1, User management requirements",
    "input_files": [
      "backend/src/main/java/com/scrumpoker/domain/user/User.java",
      "backend/src/main/java/com/scrumpoker/domain/user/UserPreference.java",
      "backend/src/main/java/com/scrumpoker/repository/UserRepository.java",
      "backend/src/main/java/com/scrumpoker/repository/UserPreferenceRepository.java"
    ],
    "target_files": [
      "backend/src/main/java/com/scrumpoker/domain/user/UserService.java",
      "backend/src/main/java/com/scrumpoker/domain/user/UserPreferenceConfig.java",
      "backend/src/main/java/com/scrumpoker/domain/user/UserNotFoundException.java"
    ],
    "deliverables": "UserService with methods: `createUser()`, `updateProfile()`, `getUserById()`, `findByEmail()`, `updatePreferences()`, `deleteUser()` (soft delete), UserPreferenceConfig POJO for JSONB fields, Email validation using regex or Bean Validation, Display name length validation (max 100 chars), Soft delete implementation (sets `deleted_at`, excludes from queries)",
    "acceptance_criteria": "Service methods pass unit tests with mocked repositories, User creation from OAuth profile maps fields correctly (oauth_provider, oauth_subject, email), Preference updates persist JSONB fields correctly, Soft delete marks user as deleted without data loss, Email validation rejects invalid formats, Service methods return reactive types (Uni, Multi)",
    "dependencies": ["I1.T4", "I1.T7"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I2.T5",
    "iteration_id": "I2",
    "iteration_goal": "Implement foundational domain services (Room Service, basic User Service), define REST API contracts (OpenAPI specification), and establish WebSocket protocol specification to enable frontend integration and parallel feature development.",
    "description": "Implement JAX-RS REST controllers for room CRUD operations following OpenAPI specification from I2.T1. Create `RoomController` with endpoints: `POST /api/v1/rooms` (create room), `GET /api/v1/rooms/{roomId}` (get room), `PUT /api/v1/rooms/{roomId}/config` (update config), `DELETE /api/v1/rooms/{roomId}` (delete), `GET /api/v1/users/{userId}/rooms` (list user's rooms). Inject `RoomService`, convert entities to DTOs, handle exceptions (404 for room not found, 400 for validation errors). Add `@RolesAllowed` annotations for authorization (room owner can delete, authenticated users can create). Return reactive `Uni<>` types for non-blocking I/O.",
    "agent_type_hint": "BackendAgent",
    "inputs": "OpenAPI specification from I2.T1 (endpoint definitions), RoomService from I2.T3, JAX-RS reactive patterns",
    "input_files": [
      "api/openapi.yaml",
      "backend/src/main/java/com/scrumpoker/domain/room/RoomService.java"
    ],
    "target_files": [
      "backend/src/main/java/com/scrumpoker/api/rest/RoomController.java",
      "backend/src/main/java/com/scrumpoker/api/rest/dto/RoomDTO.java",
      "backend/src/main/java/com/scrumpoker/api/rest/dto/CreateRoomRequest.java",
      "backend/src/main/java/com/scrumpoker/api/rest/dto/UpdateRoomConfigRequest.java",
      "backend/src/main/java/com/scrumpoker/api/rest/mapper/RoomMapper.java"
    ],
    "deliverables": "RoomController with 5 endpoint methods matching OpenAPI spec, DTO classes for requests and responses, MapStruct mapper for entity ↔ DTO conversion, Exception handlers for 404, 400 errors, Authorization annotations (`@RolesAllowed(\"USER\")`), Reactive return types (Uni<Response>)",
    "acceptance_criteria": "Endpoints accessible via `curl` or Postman against running Quarkus dev server, POST creates room, returns 201 Created with RoomDTO body, GET retrieves room by ID, returns 200 OK or 404 Not Found, PUT updates config, returns 200 OK with updated RoomDTO, DELETE soft deletes room, returns 204 No Content, GET user's rooms returns paginated list (if many rooms), DTOs match OpenAPI schema definitions exactly, Authorization prevents unauthorized users from deleting other users' rooms",
    "dependencies": ["I2.T1", "I2.T3"],
    "parallelizable": false,
    "done": false
  },
  {
    "task_id": "I2.T6",
    "iteration_id": "I2",
    "iteration_goal": "Implement foundational domain services (Room Service, basic User Service), define REST API contracts (OpenAPI specification), and establish WebSocket protocol specification to enable frontend integration and parallel feature development.",
    "description": "Implement JAX-RS REST controllers for user profile and preference management per OpenAPI spec. Create `UserController` with endpoints: `GET /api/v1/users/{userId}` (get profile), `PUT /api/v1/users/{userId}` (update profile), `GET /api/v1/users/{userId}/preferences` (get preferences), `PUT /api/v1/users/{userId}/preferences` (update preferences). Inject `UserService`, use DTOs, handle exceptions, enforce authorization (users can only access their own data unless admin). Return reactive types.",
    "agent_type_hint": "BackendAgent",
    "inputs": "OpenAPI specification from I2.T1, UserService from I2.T4",
    "input_files": [
      "api/openapi.yaml",
      "backend/src/main/java/com/scrumpoker/domain/user/UserService.java"
    ],
    "target_files": [
      "backend/src/main/java/com/scrumpoker/api/rest/UserController.java",
      "backend/src/main/java/com/scrumpoker/api/rest/dto/UserDTO.java",
      "backend/src/main/java/com/scrumpoker/api/rest/dto/UpdateProfileRequest.java",
      "backend/src/main/java/com/scrumpoker/api/rest/dto/UserPreferenceDTO.java",
      "backend/src/main/java/com/scrumpoker/api/rest/mapper/UserMapper.java"
    ],
    "deliverables": "UserController with 4 endpoint methods, DTO classes for User and UserPreference, MapStruct mapper for conversions, Authorization checks (user can only update own profile), Exception handlers (404, 403 Forbidden)",
    "acceptance_criteria": "GET /api/v1/users/{userId} returns 200 with UserDTO, PUT /api/v1/users/{userId} updates profile, returns 200, GET preferences returns UserPreferenceDTO with JSONB fields, PUT preferences updates JSONB settings correctly, Authorization prevents user A from accessing user B's data (403 Forbidden), DTOs match OpenAPI schemas",
    "dependencies": ["I2.T1", "I2.T4"],
    "parallelizable": true,
    "done": false
  },
  {
    "task_id": "I2.T7",
    "iteration_id": "I2",
    "iteration_goal": "Implement foundational domain services (Room Service, basic User Service), define REST API contracts (OpenAPI specification), and establish WebSocket protocol specification to enable frontend integration and parallel feature development.",
    "description": "Create comprehensive unit tests for `RoomService` and `UserService` using JUnit 5 and Mockito. Mock repository dependencies. Test business logic: room creation with unique ID generation, config validation, soft delete behavior, user profile updates, preference persistence. Test exception scenarios (e.g., room not found, invalid email format). Use AssertJ for fluent assertions. Aim for >90% code coverage on service classes.",
    "agent_type_hint": "BackendAgent",
    "inputs": "RoomService and UserService from I2.T3, I2.T4, JUnit 5 and Mockito testing patterns",
    "input_files": [
      "backend/src/main/java/com/scrumpoker/domain/room/RoomService.java",
      "backend/src/main/java/com/scrumpoker/domain/user/UserService.java"
    ],
    "target_files": [
      "backend/src/test/java/com/scrumpoker/domain/room/RoomServiceTest.java",
      "backend/src/test/java/com/scrumpoker/domain/user/UserServiceTest.java"
    ],
    "deliverables": "RoomServiceTest with 10+ test methods covering create, update, delete, find operations, UserServiceTest with 10+ test methods covering profile, preferences, soft delete, Mocked repository interactions using Mockito, Exception scenario tests (assertThrows for custom exceptions), AssertJ assertions for fluent readability",
    "acceptance_criteria": "`mvn test` runs all unit tests successfully, Test coverage >90% for RoomService and UserService, All business validation scenarios tested (invalid input → exception), Happy path tests verify correct repository method calls, Exception tests verify custom exceptions thrown with correct messages",
    "dependencies": ["I2.T3", "I2.T4"],
    "parallelizable": false,
    "done": false
  },
  {
    "task_id": "I2.T8",
    "iteration_id": "I2",
    "iteration_goal": "Implement foundational domain services (Room Service, basic User Service), define REST API contracts (OpenAPI specification), and establish WebSocket protocol specification to enable frontend integration and parallel feature development.",
    "description": "Create integration tests for `RoomController` and `UserController` using `@QuarkusTest` and Rest Assured. Test HTTP endpoints end-to-end: request → controller → service → repository → database → response. Use Testcontainers for PostgreSQL. Test CRUD operations, DTO mapping, error responses (404, 400), authorization (403 for unauthorized access). Validate response JSON against OpenAPI schema where possible.",
    "agent_type_hint": "BackendAgent",
    "inputs": "REST controllers from I2.T5, I2.T6, OpenAPI specification for expected responses",
    "input_files": [
      "backend/src/main/java/com/scrumpoker/api/rest/RoomController.java",
      "backend/src/main/java/com/scrumpoker/api/rest/UserController.java",
      "api/openapi.yaml"
    ],
    "target_files": [
      "backend/src/test/java/com/scrumpoker/api/rest/RoomControllerTest.java",
      "backend/src/test/java/com/scrumpoker/api/rest/UserControllerTest.java"
    ],
    "deliverables": "RoomControllerTest with tests for all 5 endpoints, UserControllerTest with tests for all 4 endpoints, Testcontainers PostgreSQL setup for integration tests, Rest Assured assertions for status codes, headers, response bodies, Tests for error scenarios (404, 400, 403)",
    "acceptance_criteria": "`mvn verify` runs integration tests successfully, POST /api/v1/rooms creates room in database, returns valid JSON, GET /api/v1/rooms/{roomId} retrieves persisted room, PUT endpoints update database and return updated DTOs, DELETE endpoints soft delete (verify `deleted_at` set), Unauthorized access returns 403 Forbidden, Response JSON structure matches OpenAPI spec",
    "dependencies": ["I2.T5", "I2.T6"],
    "parallelizable": false,
    "done": false
  }
]

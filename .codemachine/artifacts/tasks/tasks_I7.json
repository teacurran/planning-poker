[
  {
    "task_id": "I7.T1",
    "iteration_id": "I7",
    "iteration_goal": "Implement enterprise-tier features including SSO integration (OIDC/SAML2), organization management, member administration, org-level branding, and audit logging.",
    "description": "Create `SsoAdapter` service supporting OIDC and SAML2 protocols using Quarkus Security extensions. OIDC: configure IdP discovery endpoint, handle authorization code flow, validate ID token, extract user attributes (email, name, groups). SAML2: configure IdP metadata URL, handle SAML response, validate assertions, extract attributes from assertion. Map IdP attributes to User entity fields. Support per-organization SSO configuration (stored in Organization.sso_config JSONB). Implement backchannel logout (OIDC logout endpoint, SAML SLO).",
    "agent_type_hint": "BackendAgent",
    "inputs": "SSO requirements from architecture blueprint, Quarkus OIDC and SAML2 extension documentation, Enterprise SSO patterns (Okta, Azure AD)",
    "input_files": [".codemachine/artifacts/architecture/05_Operational_Architecture.md"],
    "target_files": ["backend/src/main/java/com/scrumpoker/integration/sso/SsoAdapter.java", "backend/src/main/java/com/scrumpoker/integration/sso/OidcProvider.java", "backend/src/main/java/com/scrumpoker/integration/sso/Saml2Provider.java", "backend/src/main/java/com/scrumpoker/integration/sso/SsoUserInfo.java"],
    "deliverables": "SsoAdapter with OIDC and SAML2 support, Organization-specific SSO configuration (IdP endpoint, certificate, attribute mapping from JSONB), User attribute extraction (email, name, groups/roles), Backchannel logout implementation, SSO provider-specific implementations (Okta, Azure AD tested)",
    "acceptance_criteria": "OIDC authentication flow completes with test IdP (Okta sandbox), SAML2 authentication flow completes (Azure AD or SAML test IdP), User attributes correctly mapped from ID token/assertion, Organization-specific SSO config loaded from database, Logout endpoint invalidates SSO session, Certificate validation works for SAML2",
    "dependencies": [],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I7.T2",
    "iteration_id": "I7",
    "iteration_goal": "Implement enterprise-tier features including SSO integration (OIDC/SAML2), organization management, member administration, org-level branding, and audit logging.",
    "description": "Create `OrganizationService` domain service managing enterprise organizations. Methods: `createOrganization(name, domain, ownerId)`, `updateSsoConfig(orgId, oidcConfig)` (store IdP settings in JSONB), `addMember(orgId, userId, role)`, `removeMember(orgId, userId)`, `updateBranding(orgId, logoUrl, primaryColor)`, `getOrganization(orgId)`, `getUserOrganizations(userId)`. Use `OrganizationRepository`, `OrgMemberRepository`. Validate domain ownership (user's email domain matches org domain). Enforce Enterprise tier requirement for org creation. Store branding config in Organization.branding JSONB.",
    "agent_type_hint": "BackendAgent",
    "inputs": "Organization entity from I1, Organization management requirements, SSO config structure (IdP endpoint, client ID, certificate)",
    "input_files": ["backend/src/main/java/com/scrumpoker/domain/organization/Organization.java", "backend/src/main/java/com/scrumpoker/domain/organization/OrgMember.java", "backend/src/main/java/com/scrumpoker/repository/OrganizationRepository.java"],
    "target_files": ["backend/src/main/java/com/scrumpoker/domain/organization/OrganizationService.java", "backend/src/main/java/com/scrumpoker/domain/organization/SsoConfig.java", "backend/src/main/java/com/scrumpoker/domain/organization/BrandingConfig.java"],
    "deliverables": "OrganizationService with methods for org and member management, Organization creation with domain validation, SSO configuration storage (OIDC/SAML2 settings in JSONB), Member add/remove with role assignment (ADMIN, MEMBER), Branding config storage (logo URL, colors), Enterprise tier enforcement for org features",
    "acceptance_criteria": "Creating organization validates domain (user email matches domain), SSO config persists to Organization.sso_config correctly, Adding member creates OrgMember record with role, Removing member soft-deletes membership (or hard delete based on design), Branding config JSON serializes correctly, Non-Enterprise tier cannot create organization (403)",
    "dependencies": ["I5.T4"],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I7.T3",
    "iteration_id": "I7",
    "iteration_goal": "Implement enterprise-tier features including SSO integration (OIDC/SAML2), organization management, member administration, org-level branding, and audit logging.",
    "description": "Create `AuditLogService` recording security and administrative events for Enterprise compliance. Methods: `logEvent(orgId, userId, action, resourceType, resourceId, ipAddress, userAgent)`. Events to log: user authentication (SSO login), organization config changes (SSO settings updated), member management (user added/removed/role changed), room deletion, sensitive data access. Use `AuditLogRepository`. Async event publishing (fire-and-forget via CDI event or Redis Stream for performance). Store event in partitioned AuditLog table (partition by month). Include contextual data (IP address, user agent, timestamp, change details JSONB).",
    "agent_type_hint": "BackendAgent",
    "inputs": "Audit logging requirements from architecture blueprint, AuditLog entity from I1, Events requiring audit trail",
    "input_files": ["backend/src/main/java/com/scrumpoker/domain/organization/AuditLog.java", "backend/src/main/java/com/scrumpoker/repository/AuditLogRepository.java", ".codemachine/artifacts/architecture/05_Operational_Architecture.md"],
    "target_files": ["backend/src/main/java/com/scrumpoker/domain/organization/AuditLogService.java", "backend/src/main/java/com/scrumpoker/event/AuditEvent.java"],
    "deliverables": "AuditLogService with logEvent method, Async audit event processing (CDI @ObservesAsync or Redis), Audit events for: SSO login, org config change, member add/remove, room delete, IP address and user agent extraction from HTTP request context, Change details stored in JSONB (before/after values for config changes), Integration in OrganizationService (log after member add/remove)",
    "acceptance_criteria": "SSO login creates audit log entry, Organization config change logged with before/after values, Member add event includes user ID and assigned role, Audit log query by orgId returns events sorted by timestamp, Async processing doesn't block main request thread, IP address and user agent correctly captured",
    "dependencies": [],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I7.T4",
    "iteration_id": "I7",
    "iteration_goal": "Implement enterprise-tier features including SSO integration (OIDC/SAML2), organization management, member administration, org-level branding, and audit logging.",
    "description": "Extend `AuthController` to handle SSO authentication. New endpoint: `POST /api/v1/auth/sso/callback` (handle OIDC/SAML2 callback, validate assertion, extract user info, find or create user with JIT provisioning, assign to organization based on email domain, generate JWT tokens, return TokenPair). Integrate `SsoAdapter`, `OrganizationService`. JIT provisioning: if user doesn't exist, create User entity with SSO provider info, auto-add to organization if email domain matches. Domain-based org assignment (user with `@company.com` joins org with domain `company.com`). Log SSO login to AuditLog.",
    "agent_type_hint": "BackendAgent",
    "inputs": "SSO callback flow requirements, SsoAdapter from I7.T1, OrganizationService from I7.T2, AuditLogService from I7.T3",
    "input_files": ["backend/src/main/java/com/scrumpoker/integration/sso/SsoAdapter.java", "backend/src/main/java/com/scrumpoker/domain/organization/OrganizationService.java", "backend/src/main/java/com/scrumpoker/api/rest/AuthController.java"],
    "target_files": ["backend/src/main/java/com/scrumpoker/api/rest/AuthController.java", "backend/src/main/java/com/scrumpoker/api/rest/dto/SsoCallbackRequest.java"],
    "deliverables": "SSO callback endpoint handling OIDC and SAML2, User JIT provisioning (create user on first SSO login), Email domain matching for org assignment, OrgMember creation with MEMBER role on JIT provisioning, JWT token generation for SSO-authenticated user, Audit log entry for SSO login event",
    "acceptance_criteria": "OIDC callback creates user on first login, User auto-assigned to organization matching email domain, SAML2 callback works similarly, JWT tokens returned with org membership in claims, Existing user login skips provisioning, returns tokens, Audit log records SSO login with user ID and org ID",
    "dependencies": ["I7.T1", "I7.T2", "I7.T3"],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I7.T5",
    "iteration_id": "I7",
    "iteration_goal": "Implement enterprise-tier features including SSO integration (OIDC/SAML2), organization management, member administration, org-level branding, and audit logging.",
    "description": "Implement REST endpoints for organization management per OpenAPI spec. Endpoints: `POST /api/v1/organizations` (create org, Enterprise tier only), `GET /api/v1/organizations/{orgId}` (get org details), `PUT /api/v1/organizations/{orgId}/sso` (configure SSO settings, admin only), `POST /api/v1/organizations/{orgId}/members` (invite member, admin only), `DELETE /api/v1/organizations/{orgId}/members/{userId}` (remove member, admin only), `GET /api/v1/organizations/{orgId}/audit-logs` (query audit trail, admin only). Use `OrganizationService`, `AuditLogService`. Enforce admin role checks (only org admins can modify org).",
    "agent_type_hint": "BackendAgent",
    "inputs": "OpenAPI spec for organization endpoints from I2.T1, OrganizationService from I7.T2",
    "input_files": ["api/openapi.yaml", "backend/src/main/java/com/scrumpoker/domain/organization/OrganizationService.java"],
    "target_files": ["backend/src/main/java/com/scrumpoker/api/rest/OrganizationController.java", "backend/src/main/java/com/scrumpoker/api/rest/dto/OrganizationDTO.java", "backend/src/main/java/com/scrumpoker/api/rest/dto/SsoConfigRequest.java", "backend/src/main/java/com/scrumpoker/api/rest/dto/InviteMemberRequest.java"],
    "deliverables": "OrganizationController with 6 endpoints, DTOs for organization and SSO config, Admin role enforcement (only admins can update SSO, manage members), Audit log query endpoint with pagination, Enterprise tier enforcement for org creation",
    "acceptance_criteria": "POST /organizations creates org (Enterprise tier only), PUT /sso updates SSO configuration (admin only, 403 for members), POST /members invites user to org, DELETE /members removes user from org, GET /audit-logs returns paginated audit events, Non-admin requests to admin endpoints return 403",
    "dependencies": ["I7.T2", "I7.T3"],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I7.T6",
    "iteration_id": "I7",
    "iteration_goal": "Implement enterprise-tier features including SSO integration (OIDC/SAML2), organization management, member administration, org-level branding, and audit logging.",
    "description": "Implement React components for organization administration (Enterprise tier). `OrganizationSettingsPage`: display org name, domain, member count, branding preview, \"Configure SSO\" button. `SsoConfigPage`: form for OIDC settings (IdP URL, client ID, client secret) or SAML2 settings (IdP metadata URL, certificate upload), test SSO button. `MemberManagementPage`: table listing org members (name, email, role), \"Invite Member\" button, role change dropdown, remove button. `AuditLogPage`: audit event table (timestamp, user, action, resource, IP), date range filter, pagination. Conditional rendering based on user's org admin role.",
    "agent_type_hint": "FrontendAgent",
    "inputs": "Organization management requirements, OpenAPI spec for organization endpoints, Enterprise tier UI patterns",
    "input_files": ["api/openapi.yaml"],
    "target_files": ["frontend/src/pages/org/OrganizationSettingsPage.tsx", "frontend/src/pages/org/SsoConfigPage.tsx", "frontend/src/pages/org/MemberManagementPage.tsx", "frontend/src/pages/org/AuditLogPage.tsx", "frontend/src/components/org/MemberTable.tsx", "frontend/src/services/organizationApi.ts"],
    "deliverables": "OrganizationSettingsPage showing org details, SsoConfigPage with OIDC/SAML2 configuration form, MemberManagementPage with member table and invite/remove actions, AuditLogPage with filterable event table, React Query hooks for organization API calls, Admin-only access (redirect non-admins to 403 page)",
    "acceptance_criteria": "OrganizationSettingsPage displays org name and member count, SsoConfigPage form submits to /organizations/{id}/sso endpoint, SSO test button validates configuration, MemberManagementPage lists current members, Invite member opens modal, calls POST /members, Remove member confirms action, calls DELETE /members/{userId}, AuditLogPage displays events with timestamp, action, user, Non-admin users cannot access org admin pages (403 or redirect)",
    "dependencies": ["I7.T5"],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I7.T7",
    "iteration_id": "I7",
    "iteration_goal": "Implement enterprise-tier features including SSO integration (OIDC/SAML2), organization management, member administration, org-level branding, and audit logging.",
    "description": "Create integration test for SSO authentication flow using mock IdP. Test OIDC: mock authorization server, valid ID token, callback processes successfully, user created (JIT provisioning), org assignment, JWT tokens returned. Test SAML2: mock SAML response, assertion validated, user provisioned, tokens returned. Test audit log entry creation. Use Testcontainers for PostgreSQL.",
    "agent_type_hint": "BackendAgent",
    "inputs": "SSO callback handler from I7.T4, Mock IdP patterns (WireMock for OIDC, SAML test assertions)",
    "input_files": ["backend/src/main/java/com/scrumpoker/api/rest/AuthController.java", "backend/src/main/java/com/scrumpoker/integration/sso/SsoAdapter.java"],
    "target_files": ["backend/src/test/java/com/scrumpoker/api/rest/SsoAuthenticationIntegrationTest.java", "backend/src/test/resources/sso/mock_id_token.jwt", "backend/src/test/resources/sso/mock_saml_response.xml"],
    "deliverables": "Integration test for OIDC SSO flow, Integration test for SAML2 SSO flow, Mock IdP responses (ID token, SAML assertion), Assertions: user created, org assigned, tokens returned, Audit log entry verified",
    "acceptance_criteria": "`mvn verify` runs SSO integration tests, OIDC test creates user on first login, User assigned to organization based on email domain, SAML2 test works similarly, JWT tokens returned contain org membership claim, Audit log entry created for SSO login",
    "dependencies": ["I7.T4"],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I7.T8",
    "iteration_id": "I7",
    "iteration_goal": "Implement enterprise-tier features including SSO integration (OIDC/SAML2), organization management, member administration, org-level branding, and audit logging.",
    "description": "Create unit tests for `OrganizationService` with mocked repositories. Test scenarios: create organization (verify domain validation), add member (verify OrgMember created), remove member (verify deletion), update SSO config (verify JSONB serialization), update branding (verify JSONB persistence). Test edge cases: duplicate member addition, removing last admin (prevent), invalid domain.",
    "agent_type_hint": "BackendAgent",
    "inputs": "OrganizationService from I7.T2, Mockito testing patterns",
    "input_files": ["backend/src/main/java/com/scrumpoker/domain/organization/OrganizationService.java"],
    "target_files": ["backend/src/test/java/com/scrumpoker/domain/organization/OrganizationServiceTest.java"],
    "deliverables": "OrganizationServiceTest with 12+ test methods, Tests for org creation, member management, SSO config, Edge case tests (duplicate member, remove last admin), JSONB serialization tests (SSO config, branding)",
    "acceptance_criteria": "`mvn test` runs organization service tests, Org creation validates email domain matches org domain, Add member creates OrgMember with correct role, Remove last admin throws exception (prevent lockout), SSO config persists to JSONB correctly, Branding config round-trips through JSONB",
    "dependencies": ["I7.T2"],
    "parallelizable": true,
    "done": true
  }
]
